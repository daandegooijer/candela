# Storyblok Webhook Setup

## Overview

This project uses Storyblok webhooks to trigger on-demand revalidation in
Next.js via Incremental Static Regeneration (ISR). When you publish or unpublish
content in Storyblok, the webhook automatically updates the static pages.

## Setup Instructions

### 1. Add Environment Variables

Add to your `.env.local`:

```env
STORYBLOK_WEBHOOK_SECRET=your-webhook-secret-here
```

**Generate a secure secret** (minimum 32 characters):

```bash
openssl rand -base64 32
```

### 2. Configure Webhook in Storyblok

1. Go to your Storyblok space settings
2. Navigate to **Webhooks**
3. Click **Add Webhook**
4. Fill in the following:

**URL:**

```
https://your-domain.com/api/webhooks/storyblok
```

**Events:** Select:

- ✓ Story published
- ✓ Story unpublished

**Custom Headers:** Add:

- Header Name: `x-storyblok-signature`
- Header Value: (This is auto-generated by the webhook in reality - leave empty,
  Storyblok will populate it)

**Secret:** Paste your webhook secret (the same one in `.env.local`)

**Example webhook URL for local testing:**

```
http://localhost:3000/api/webhooks/storyblok
```

### 3. Test the Webhook

1. **Publish a story** in Storyblok
2. **Check your Next.js logs** - you should see:
   ```
   Webhook received: published - your-story-slug
   Revalidated: /your-story-slug
   ```
3. **Visit the page** - it should have the latest content

## How It Works

```
Storyblok (Publish Content)
        ↓
   Webhook Request
        ↓
Next.js API Route (/api/webhooks/storyblok)
        ↓
   Signature Verification
        ↓
   revalidatePath() called
        ↓
   Page regenerated on-demand (ISR)
        ↓
   User sees latest content
```

## Revalidation Strategy

- **On-demand:** Immediately when content is published/unpublished via webhook
- **Fallback:** Every 1 hour (`revalidate = 3600`) if webhook fails
- **Static:** First page load is served from cache, subsequent updates trigger
  regeneration

## Webhook Security

The webhook validates:

- ✓ HMAC-SHA256 signature (prevents unauthorized calls)
- ✓ Secret key matches environment variable
- ✓ Request contains valid story slug

## Troubleshooting

**Webhook not firing?**

- Check webhook URL is publicly accessible
- Verify secret matches exactly (case-sensitive)
- Check Storyblok webhook logs in space settings

**Pages not updating?**

- Check Next.js build logs for revalidation messages
- Verify `revalidate` export is set
- Clear `.next` folder and rebuild if needed

**Local development?**

- Use ngrok or similar to expose localhost publicly
- Update webhook URL to your ngrok domain
- Keep `STORYBLOK_WEBHOOK_SECRET` in `.env.local`

## Webhook Payload Example

```json
{
  "action": "published",
  "story": {
    "id": 123456,
    "name": "Page Title",
    "slug": "page-title",
    "published_at": "2025-01-10T12:00:00Z"
  }
}
```
